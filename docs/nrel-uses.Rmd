---
title: "Ocean Uses and Marine Renewable Energy"
author: "Ben Best"
date: '`r format(Sys.time(), "%Y-%m-%d %H:%M")`'
output:
  pdf_document:
    fig_caption: yes
    toc: yes
  html_document:
    toc: yes
    toc_depth: '4'
  word_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
# TODO: 
# - for (energy in c("tide","wave","wind")){...}
# - contours of depth bins for map.
# - zoom in for West (NOTE: 2x-clicking on html zooms)
# - corresponding table/plot of "Area (km^2) by Tide/Wave/Wind" and map with contours of energy bins.

library(tidyverse)
library(knitr)
library(rmarkdown)
#library(bookdown)
library(glue)
library(sf)
library(raster)
library(formattable)
library(htmltools)
library(DT)
library(leaflet)
library(yaml)
library(here)
devtools::load_all("~/github/nrelutils") # devtools::install_github("ecoquants/nrelutils"); library(nrelutils) 
select <- dplyr::select

knitr::opts_chunk$set(warning=F, message=F, eval=T, echo=F, cache=F)

# paths ----
dir_data      <- here("data")
dir_prep      <- here("prep")
dir_prep_data <- here("prep/data")
lyr_params_csv      <- here("prep/prep_params.csv")
lyr_categories_xlsx <- here("data/categories_and_datasets.xlsx")
eez_s05_wgcs_geo    <- here("prep/data/eez/usa_ter_simplify05_wgcs.geojson")

lyr_categories  <- readxl::read_xlsx(lyr_categories_xlsx, sheet="datasets")
lyr_params      <- suppressMessages(readr::read_csv(lyr_params_csv))
eez_s05_wgcs_sf <- read_sf(eez_s05_wgcs_geo)
limits          <- nrelutils::nrel_limits

i_tbl <<- 0
src <- NULL

# iterate over territories and bins
territories <- eez_s05_wgcs_sf$territory  # territories <- c("Atlantic Islands","West")
#bins <- names(limits) # 
bins <- c("depth","wind") # bins <- c("depth")
#territories <- c("Atlantic Islands","West"); bins <- c("depth")

for (ter in territories){ # ter = "Atlantic Islands" # territories[1]

      src <- c(src, glue("
## {ter}

```{{r {ter}}}
ter <- '{ter}'
```"))

  ter_cnt_yml      <- glue("{dir_data}/territories/{ter}_cnt.yml")
  ter_bin_lyr_csvs <- glue("{dir_data}/territories/{ter}_{bins}.csv")
  ter_bin_cnt_csvs <- glue("{dir_data}/territories/{ter}_{bins}_cnt.csv")
  lyrs_redo <- lyr_params %>% 
    filter(key %in% names(limits), redo == TRUE)

  # get raster stack data for territory if needed
  if (any(!file.exists(c(ter_bin_lyr_csvs, ter_bin_cnt_csvs, ter_cnt_yml))) | nrow(lyrs_redo) > 0){
    s     <- ter_stack(ter, lyr_params, dir_prep_data)  
    tbl_s <- ter_stack_tbl(s)
  }
  
  if (!file.exists(ter_cnt_yml))
    make_ter_cnt_yml(s, ter_cnt_yml, dir_data, ter)
  info <- yaml.load_file(ter_cnt_yml)
  
  src <- c(src, glue("
### Map of Ocean Use

```{{r map{ter}, fig.cap='{map_caption_ter_cnt(ter)}'}}
map_ter_cnt('{ter_cnt_yml}')
```"))
  
  for (bin in bins){ # bin = bins[1]
    ter_bin_lyr_csv <- glue("{dir_data}/territories/{ter}_{bin}.csv")
    ter_bin_cnt_csv <- glue("{dir_data}/territories/{ter}_{bin}_cnt.csv")
    bin_html    <- lyr_params %>% 
      filter(key == bin) %>%
      .$title
    
    # skip bin if not in territory
    if (!bin %in% info$raster$layers){
      write_lines(ter_bin_lyr_csv, "NA")
      write_lines(ter_bin_cnt_csv, "NA")
      next()
    }
    
    if (any(!file.exists(c(ter_bin_lyr_csv, ter_bin_cnt_csv))) | bin %in% lyrs_redo$key){
      tbl_b   <- ter_bin(tbl_s, bin)
    }
    
    if (!file.exists(ter_bin_lyr_csv) | bin %in% lyrs_redo$key){
      tbl_bl  <- ter_bin_lyr(tbl_b)
      tbl_bls <- ter_bin_lyr_smry(tbl_bl)
      write_csv(tbl_bls, ter_bin_lyr_csv)
    } 
    
    if (!file.exists(ter_bin_cnt_csv) | bin %in% lyrs_redo$key){
      tbl_bc  <- ter_bin_cnt(tbl_b)
      write_csv(tbl_bc, ter_bin_cnt_csv)
    } 
    
    src <- c(src, glue("
```{{r {ter}-{bin}}}
bin         <- '{bin}'
bin_html    <- lyr_params %>% 
  filter(key == bin) %>%
  .$title
```"))

    # TODO: if (fmt=="html_document")
    src <- c(src, glue("
### Plot of Ocean Use by {bin_html}

```{{r fig{ter}{bin}, fig.cap='{plot_caption_ter_bin_cnt(ter, bin_html)}'}}
plot_ter_bin_cnt('{dir_data}/territories/{ter}_{bin}_cnt.csv', bin_html)
```"))
    
    src <- c(src, glue("
### Table of Ocean Use by {bin_html}

```{{r tbl{ter}{bin}}}
tbl_blsp <- ter_bin_lyr_smry_plus('{dir_data}/territories/{ter}_{bin}.csv', lyr_params, lyr_categories)
print_ter_bin_lyr_smry_plus(tbl_blsp)
```"))

  }
}

src <- sprintf("%s\n", src)
write_lines(src, "nrel-uses_src.Rmd")
res = knit_child(text = unlist(src))
```

```{r knitted_result, results="asis"}
cat(paste(res, collapse = "\n"))
```
